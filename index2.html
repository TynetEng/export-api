<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employee Attestation</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script type="text/javascript" src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<script>
    console.log("MSAL Loaded:", window.msal);
</script>


<style>
        body {
            background: white;
            color: black;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 600px;
            background: rgba(243, 112, 33, 0.9);
            padding: 30px;
            border-radius: 10px;
            margin-top: 50px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .logo {
            width: 200px;
            margin-bottom: 20px;
        }
        h1 {
            font-weight: bold;
        }
        .form-control {
            background-color: rgba(255, 255, 255, 0.2);
            color: black;
            border: 1px solid #ffffff;
        }
        .btn-success {
            width: 100%;
            background-color: #F37021;
            border: none;
            padding: 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
        }
        .btn-success:disabled {
            background-color: gray;
        }
        .document-container {
            margin-top: 20px;
            text-align: center;
        }
        .document-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
</style>
</head>
<body>
<div class="container">
<img src="https://engelindustries.com.au/wp-content/uploads/2024/12/Engel-Industries-White.png" alt="Company Logo" class="logo">
<h1>Attestation Form</h1>
<form id="contactForm">
<div class="form-group">
<label for="firstName">First Name</label>
<input type="text" class="form-control" id="firstName" name="firstName" required>
</div>
<div class="form-group">
<label for="lastName">Last Name</label>
<input type="text" class="form-control" id="lastName" name="lastName" required>
</div>
<div class="form-group">
<label for="email">Email Address</label>
<input type="email" class="form-control" id="email" name="email" required>
</div>
 
            <!-- Dropdown for selecting document -->
<div class="form-group">
<label for="documentSelect">Select a Document</label>
<select class="form-control" id="documentSelect" required>
<option value="">-- Select Document --</option>
</select>
</div>
 
            <!-- Document Display -->
<div class="document-container">
<iframe id="documentIframe" src="" title="Document" style="display: none;"></iframe>
</div>
 
            <!-- Confirmation Checkbox -->
<div class="form-check mt-3" style="display: none;" id="confirmContainer">
<input class="form-check-input" type="checkbox" id="confirmCheck">
<label class="form-check-label" for="confirmCheck">I confirm I have reviewed the document</label>
</div>
 
            <button type="submit" class="btn btn-success mt-3" id="submitButton" disabled>Submit</button>
</form>
</div>
 
    <script>
        const documentSelect = document.getElementById("documentSelect");
        const documentIframe = document.getElementById("documentIframe");
        const confirmCheck = document.getElementById("confirmCheck");
        const submitButton = document.getElementById("submitButton");
        const confirmContainer = document.getElementById("confirmContainer");
 
        // Static OAuth Bearer token for authentication
        //const oauthToken = "YOUR_STATIC_OAUTH_TOKEN_HERE";  // Replace with your actual token

        const msalConfig = {
            auth: {
                clientId: "0e086350-631c-414b-a27b-c38c72901970",  
                authority: "https://login.microsoftonline.com/8900c5e2-270f-4ca0-9a2c-85889720d198",
                redirectUri: window.location.origin 
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: true,
            }
        };

        const msalInstance =new msal.PublicClientApplication(msalConfig);

        console.log("msalInstance:",msalInstance)
        msalInstance.handleRedirectPromise().then(response => {
            if (response && response.account) {
                console.log("Silent authentication successful via redirect:", response);
                msalInstance.setActiveAccount(response.account);
            }
        }).catch(error => {
            console.error("Silent authentication error:", error);
        });
       
        const loginRequest = {
            scopes: ["Files.Read.All", "Sites.Read.All"]
        };

        async function getAccessToken() {
            console.log("Initializing MSAL...");
            await msalInstance.initialize(); 
        
            let account = msalInstance.getActiveAccount();
            console.log("Active account:", account);
        
            if (!account) {
                const accounts = msalInstance.getAllAccounts();
                console.log("Available accounts:", accounts);
        
                if (accounts.length > 0) {
                    account = accounts[0];
                    msalInstance.setActiveAccount(account);
                } else {
                    console.warn("No active session. User must log in via Microsoft.");
                    return null;
                }
            }
        
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ["Files.Read.All", "Sites.Read.All"],
                    account: account
                });
        
                console.log("Silent authentication successful!");
                return tokenResponse.accessToken;
            } catch (error) {
                console.error("Silent authentication failed:", error);
                return null; // No popup fallback
            }
        }
        
    
    
       
        
        
        
 
        // Fetch documents from SharePoint
        

        async function fetchDocuments() {
            const accessToken = await getAccessToken();
            if (!accessToken) {
                console.error("Authentication failed. Cannot load documents.");
                return;
            }
        
            const sharepointUrl = "https://wajesmartltd.sharepoint.com/sites/HeritageOil/_api/web/lists/getbytitle('Shared%20Documents')/items"; 
            
            try {
                const response = await fetch(sharepointUrl, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json;odata=verbose",
                        "Authorization": `Bearer ${accessToken}`
                    }
                });
        
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        
                const data = await response.json();
                console.log("SharePoint Response:", data);
        
                const documents = data.d.results;
        
                // Populate dropdown
                documentSelect.innerHTML = `<option value="">-- Select Document --</option>`;
                documents.forEach(doc => {
                    const option = document.createElement("option");
                    option.value = doc.FileRef;
                    option.textContent = doc.FileLeafRef;
                    documentSelect.appendChild(option);
                });
        
            } catch (error) {
                console.error("Error fetching documents:", error);
            }
        }

        msalInstance.handleRedirectPromise().then(() => {
            fetchDocuments();
        }).catch(error => {
            console.error("Redirect error:", error);
        });

        documentSelect.addEventListener("change", function () {
            const selectedDocUrl = this.value;
    
            if (selectedDocUrl) {
                documentIframe.src = selectedDocUrl;
                documentIframe.style.display = "block";
                confirmContainer.style.display = "block";
            } else {
                documentIframe.style.display = "none";
                confirmContainer.style.display = "none";
                submitButton.disabled = true;
            }
        });
    
        confirmCheck.addEventListener("change", function() {
            submitButton.disabled = !this.checked;
        });
</script>
</body>
</html>